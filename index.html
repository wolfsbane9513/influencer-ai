<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfluencerFlow AI - Fixed Integration Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .success { background: linear-gradient(90deg, #10b981, #059669); }
        .warning { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .error { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE = 'http://localhost:8000';

        const TestInterface = () => {
            const [systemStatus, setSystemStatus] = useState(null);
            const [testResults, setTestResults] = useState({});
            const [activeConversation, setActiveConversation] = useState(null);
            const [conversationStatus, setConversationStatus] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [logs, setLogs] = useState([]);

            useEffect(() => {
                checkSystemHealth();
            }, []);

            const addLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [...prev, { timestamp, message, type }]);
            };

            const checkSystemHealth = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/health`);
                    const data = await response.json();
                    setSystemStatus(data);
                    addLog('System health check completed', 'success');
                } catch (error) {
                    addLog(`Health check failed: ${error.message}`, 'error');
                }
            };

            const runEndToEndTest = async () => {
                setIsLoading(true);
                addLog('Starting complete end-to-end test...', 'info');
                
                try {
                    const response = await fetch(`${API_BASE}/api/test/simulate-full-conversation`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        setTestResults(result);
                        setActiveConversation(result.conversation_id);
                        addLog('üéâ End-to-end test SUCCESSFUL!', 'success');
                        addLog(`Conversation ID: ${result.conversation_id}`, 'info');
                        addLog(`Final deal: $${result.final_deal.price} for ${result.final_deal.timeline}`, 'success');
                        addLog(`Tools used: ${result.tools_used.join(', ')}`, 'info');
                    } else {
                        addLog(`Test failed: ${result.detail || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    addLog(`Test failed: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const createSimpleConversation = async () => {
                setIsLoading(true);
                addLog('Creating simple conversation...', 'info');
                
                try {
                    const response = await fetch(`${API_BASE}/api/elevenlabs/simulate-call`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            creator_id: "sarah_tech",
                            campaign_brief: {
                                brand_name: "TechBrand Agency",
                                product_name: "iPhone MagSafe Case", 
                                campaign_type: "Product Review",
                                deliverables: ["video_review", "instagram_post"],
                                budget_max: 4000
                            },
                            brand_name: "TechBrand Agency",
                            contact_person: "Test Manager"
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        setActiveConversation(result.conversation_id);
                        addLog('‚úÖ Conversation created successfully', 'success');
                        addLog(`Conversation ID: ${result.conversation_id}`, 'info');
                    } else {
                        addLog(`Failed to create conversation: ${result.detail}`, 'error');
                    }
                } catch (error) {
                    addLog(`Failed to create conversation: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const checkConversationStatus = async () => {
                if (!activeConversation) {
                    addLog('No active conversation to check', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/conversation-status/${activeConversation}`);
                    const data = await response.json();
                    
                    setConversationStatus(data);
                    addLog(`Status checked: ${data.status}`, 'success');
                    addLog(`Messages: ${data.transcript?.length || 0}`, 'info');
                } catch (error) {
                    addLog(`Status check failed: ${error.message}`, 'error');
                }
            };

            const addCreatorResponse = async () => {
                if (!activeConversation) {
                    addLog('No active conversation for creator response', 'warning');
                    return;
                }
                
                setIsLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/api/creator-response`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            conversation_id: activeConversation,
                            creator_response: "I usually charge $5000, and I need at least 3 weeks for quality content."
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        addLog('‚úÖ Creator response added', 'success');
                        addLog(`AI replied: "${result.ai_response.substring(0, 100)}..."`, 'info');
                        addLog(`Tools used: ${result.tools_used.join(', ')}`, 'info');
                        
                        // Refresh status
                        await checkConversationStatus();
                    } else {
                        addLog(`Failed to add response: ${result.error}`, 'error');
                    }
                } catch (error) {
                    addLog(`Failed to add response: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const testUpdateDealTool = async () => {
                if (!activeConversation) {
                    addLog('No active conversation for tool test', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/tools/update-deal`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            conversation_id: activeConversation,
                            price: 4500,
                            timeline: "3 weeks",
                            rationale: "Test tool call - updating deal parameters"
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        addLog('‚úÖ Update deal tool test successful', 'success');
                        addLog(`New price: $${result.updated_deal.price}`, 'info');
                        await checkConversationStatus();
                    } else {
                        addLog(`Tool test failed: ${result.error}`, 'error');
                    }
                } catch (error) {
                    addLog(`Tool test failed: ${error.message}`, 'error');
                }
            };

            const testCreatorInsightsTool = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/tools/creator-insights?creator_id=sarah_tech&niche=tech`);
                    const result = await response.json();
                    
                    if (result.success) {
                        addLog('‚úÖ Creator insights tool test successful', 'success');
                        addLog(`Creator engagement: ${result.creator_data?.engagement_rate}%`, 'info');
                    } else {
                        addLog(`Tool test failed: ${result.error}`, 'error');
                    }
                } catch (error) {
                    addLog(`Tool test failed: ${error.message}`, 'error');
                }
            };

            const resetConversations = async () => {
                try {
                    await fetch(`${API_BASE}/api/debug/reset-conversations`, { method: 'POST' });
                    setActiveConversation(null);
                    setConversationStatus(null);
                    setTestResults({});
                    addLog('üîÑ All conversations reset', 'info');
                } catch (error) {
                    addLog(`Reset failed: ${error.message}`, 'error');
                }
            };

            return (
                <div className="max-w-6xl mx-auto p-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-lg mb-6">
                        <h1 className="text-3xl font-bold mb-2">üéØ InfluencerFlow AI - Fixed Integration Test</h1>
                        <p className="text-blue-100">Complete system testing with working conversation management and tool integration</p>
                        
                        {systemStatus && (
                            <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div className={`p-2 rounded ${systemStatus.system.elevenlabs_api_configured ? 'bg-green-500' : 'bg-red-500'}`}>
                                    ElevenLabs: {systemStatus.system.elevenlabs_api_configured ? 'Configured' : 'Not Set'}
                                </div>
                                <div className="p-2 rounded bg-blue-500">
                                    Active: {systemStatus.system.active_conversations}
                                </div>
                                <div className="p-2 rounded bg-green-500">
                                    Tools: {Object.keys(systemStatus.tools).length}
                                </div>
                                <div className="p-2 rounded bg-purple-500">
                                    Status: {systemStatus.status}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Test Controls */}
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-xl font-bold mb-4">üß™ Test Controls</h2>
                            
                            <div className="space-y-4">
                                <button
                                    onClick={runEndToEndTest}
                                    disabled={isLoading}
                                    className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-lg hover:from-green-600 hover:to-green-700 disabled:opacity-50"
                                >
                                    {isLoading ? 'üîÑ Running...' : 'üöÄ Run Complete End-to-End Test'}
                                </button>
                                
                                <div className="border-t pt-4">
                                    <h3 className="font-semibold mb-2">Step-by-Step Testing:</h3>
                                    
                                    <button
                                        onClick={createSimpleConversation}
                                        disabled={isLoading}
                                        className="w-full mb-2 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 disabled:opacity-50"
                                    >
                                        1. Create Conversation
                                    </button>
                                    
                                    <button
                                        onClick={checkConversationStatus}
                                        disabled={!activeConversation}
                                        className="w-full mb-2 bg-purple-500 text-white p-2 rounded hover:bg-purple-600 disabled:opacity-50"
                                    >
                                        2. Check Status
                                    </button>
                                    
                                    <button
                                        onClick={addCreatorResponse}
                                        disabled={!activeConversation || isLoading}
                                        className="w-full mb-2 bg-orange-500 text-white p-2 rounded hover:bg-orange-600 disabled:opacity-50"
                                    >
                                        3. Add Creator Response
                                    </button>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <button
                                            onClick={testUpdateDealTool}
                                            disabled={!activeConversation}
                                            className="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600 disabled:opacity-50 text-sm"
                                        >
                                            Test Update Tool
                                        </button>
                                        
                                        <button
                                            onClick={testCreatorInsightsTool}
                                            className="bg-indigo-500 text-white p-2 rounded hover:bg-indigo-600 text-sm"
                                        >
                                            Test Insights Tool
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="border-t pt-4">
                                    <button
                                        onClick={resetConversations}
                                        className="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600"
                                    >
                                        üóëÔ∏è Reset All Conversations
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Status Display */}
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-xl font-bold mb-4">üìä Current Status</h2>
                            
                            {activeConversation && (
                                <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded">
                                    <strong>Active Conversation:</strong><br/>
                                    <code className="text-sm">{activeConversation}</code>
                                </div>
                            )}
                            
                            {conversationStatus && (
                                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
                                    <h3 className="font-semibold">Conversation Details:</h3>
                                    <div className="text-sm mt-2">
                                        <div><strong>Creator:</strong> {conversationStatus.creator_name}</div>
                                        <div><strong>Status:</strong> {conversationStatus.status}</div>
                                        <div><strong>Price:</strong> ${conversationStatus.current_deal?.price?.toLocaleString()}</div>
                                        <div><strong>Timeline:</strong> {conversationStatus.current_deal?.timeline}</div>
                                        <div><strong>Messages:</strong> {conversationStatus.transcript?.length}</div>
                                        <div><strong>Tools Used:</strong> {conversationStatus.tools_used?.join(', ') || 'None'}</div>
                                    </div>
                                </div>
                            )}
                            
                            {testResults.success && (
                                <div className="p-3 bg-green-50 border border-green-200 rounded">
                                    <h3 className="font-semibold text-green-800">üéâ End-to-End Test Results:</h3>
                                    <div className="text-sm mt-2">
                                        <div><strong>Final Deal:</strong> ${testResults.final_deal?.price?.toLocaleString()}</div>
                                        <div><strong>Timeline:</strong> {testResults.summary?.timeline}</div>
                                        <div><strong>Tools Used:</strong> {testResults.tools_used?.join(', ')}</div>
                                        <div><strong>Messages:</strong> {testResults.summary?.total_messages}</div>
                                        <div><strong>Success:</strong> {testResults.summary?.negotiation_successful ? 'Yes' : 'No'}</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Live Log */}
                    <div className="mt-6 bg-black text-green-400 p-4 rounded-lg">
                        <h3 className="font-bold mb-2">üìù Live Test Log</h3>
                        <div className="h-64 overflow-y-auto font-mono text-sm">
                            {logs.map((log, index) => (
                                <div key={index} className={`mb-1 ${
                                    log.type === 'success' ? 'text-green-400' :
                                    log.type === 'error' ? 'text-red-400' :
                                    log.type === 'warning' ? 'text-yellow-400' :
                                    'text-green-400'
                                }`}>
                                    <span className="text-gray-500">[{log.timestamp}]</span> {log.message}
                                </div>
                            ))}
                            {logs.length === 0 && (
                                <div className="text-gray-500">Waiting for test activity...</div>
                            )}
                        </div>
                    </div>

                    {/* Instructions */}
                    <div className="mt-6 bg-blue-50 border border-blue-200 p-4 rounded-lg">
                        <h3 className="font-semibold text-blue-800 mb-2">üìã Testing Instructions</h3>
                        <ol className="text-sm text-blue-700 space-y-1">
                            <li><strong>1. Quick Test:</strong> Click "Run Complete End-to-End Test" for automated full testing</li>
                            <li><strong>2. Step by Step:</strong> Use individual buttons to test each component</li>
                            <li><strong>3. Conversation Flow:</strong> Create ‚Üí Check Status ‚Üí Add Response ‚Üí Test Tools</li>
                            <li><strong>4. Tool Testing:</strong> Test both update-deal and creator-insights tools</li>
                            <li><strong>5. Reset:</strong> Use reset button to clear all conversations between tests</li>
                        </ol>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TestInterface />, document.getElementById('root'));
    </script>
</body>
</html>